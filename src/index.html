<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Neg√≥cios - Cat√°logo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    :root {
      --primary: #3850A0;
      --primary-dark: #2A407E;
      --bg-page: #F8F9FA;
      --bg-card: #FFFFFF;
      --border: #E5E7EB;
      --text-dark: #1F2937;
      --text-muted: #9CA3AF;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
    }
    .btn-primary { background: var(--primary); color: white; font-weight: 500; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-dark); }
    .btn-secondary:hover { background: var(--bg-page); }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
    .plan-card { background: var(--bg-page); border: 1px solid var(--border); border-radius: 10px; }
    .plan-card:hover { border-color: var(--primary); background: white; }
    .addon-chip { background: var(--bg-page); border: 1px solid var(--border); border-radius: 8px; }
    .addon-chip:hover { border-color: var(--primary); background: white; }
    .addon-chip.required { border-color: var(--warning); background: #FFFBEB; }
    .modal-backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
    input, select, textarea { background: white !important; border: 1px solid var(--border) !important; color: var(--text-dark) !important; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary) !important; outline: none; }
    .category-header { background: linear-gradient(90deg, rgba(56, 80, 160, 0.05) 0%, transparent 100%); }
    .badge { font-size: 11px; font-weight: 500; padding: 4px 10px; border-radius: 20px; }
    .badge-active { background: #ECFDF5; color: #059669; }
    .badge-inactive { background: #F3F4F6; color: #6B7280; }
    .badge-required { background: #FEF3C7; color: #B45309; }
    .badge-setup { background: #FEF3C7; color: #B45309; }
    .badge-count { background: #EEF2FF; color: var(--primary); }
    .icon-box { background: #EEF2FF; color: var(--primary); }
    .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapse-content.open { max-height: 5000px; transition: max-height 0.5s ease-in; }
    .chevron { transition: transform 0.3s; }
    .chevron.open { transform: rotate(180deg); }
    .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; }
    .icon-item { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
    .icon-item:hover { border-color: var(--primary); background: #EEF2FF; }
    .icon-item.selected { border-color: var(--primary); background: var(--primary); }
    .icon-item.selected svg { stroke: white; }
    svg { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="background: var(--bg-page); color: var(--text-dark); min-height: 100vh;">
  
  <header class="px-6 py-4 border-b" style="background: white; border-color: var(--border);">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg flex items-center justify-center icon-box">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold">Cat√°logo</h1>
          <p class="text-xs" style="color: var(--text-muted);">Produtos, servi√ßos e op√ß√µes</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="openCategoryModal()" class="btn-secondary flex items-center gap-2 px-4 py-2 rounded-lg text-sm">
          <svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Nova Categoria
        </button>
        <button onclick="openProductModal()" class="btn-primary flex items-center gap-2 px-4 py-2 rounded-lg text-sm">
          <svg class="w-4 h-4" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Novo Item
        </button>
      </div>
    </div>
  </header>
  
  <main class="p-6">
    <div class="space-y-4" id="catalogTree"></div>
  </main>
  
  <!-- Modal: Produto -->
  <div id="productModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeProductModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <h2 class="text-base font-semibold" id="productModalTitle">Novo Item</h2>
        <button onclick="closeProductModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <form id="productForm" onsubmit="saveProduct(event)">
          <input type="hidden" id="productId">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1.5">Categoria *</label>
              <select id="productCategory" required class="w-full px-3 py-2.5 rounded-lg text-sm"><option value="">Selecione...</option></select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Nome *</label>
              <input type="text" id="productName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Sistema de Gest√£o...">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Descri√ß√£o</label>
              <textarea id="productDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="Descri√ß√£o..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">C√≥digo/SKU</label>
                <input type="text" id="productSku" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="PROD-001">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Status</label>
                <select id="productStatus" class="w-full px-3 py-2.5 rounded-lg text-sm"><option value="active">Ativo</option><option value="inactive">Inativo</option></select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeProductModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button type="submit" form="productForm" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Op√ß√£o -->
  <div id="planModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closePlanModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <div>
          <h2 class="text-base font-semibold" id="planModalTitle">Nova Op√ß√£o</h2>
          <p class="text-xs" id="planModalSubtitle" style="color: var(--text-muted);">Item: -</p>
        </div>
        <button onclick="closePlanModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <form id="planForm" onsubmit="savePlan(event)">
          <input type="hidden" id="planId"><input type="hidden" id="planProductId">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Nome *</label>
                <input type="text" id="planName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: B√°sico...">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">C√≥digo/SKU</label>
                <input type="text" id="planSku" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="OPC-001">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Descri√ß√£o</label>
              <textarea id="planDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="O que est√° inclu√≠do..."></textarea>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Pre√ßo *</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm" style="color: var(--text-muted);">R$</span>
                  <input type="text" id="planPrice" required class="w-full pl-10 pr-3 py-2.5 rounded-lg text-sm" placeholder="0,00" oninput="formatCurrencyInput(this)">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Ciclo</label>
                <select id="planBillingCycle" class="w-full px-3 py-2.5 rounded-lg text-sm">
                  <option value="one_time">√önico</option><option value="monthly">Mensal</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="yearly">Anual</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Ordem</label>
                <input type="number" id="planOrder" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="1">
              </div>
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-sm font-medium">Recursos / Diferenciais</label>
                <button type="button" onclick="addPlanFeature()" class="text-xs font-medium" style="color: var(--primary);">+ Adicionar</button>
              </div>
              <div id="planFeaturesList" class="space-y-2"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closePlanModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button type="submit" form="planForm" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Adicional -->
  <div id="addonModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeAddonModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <div>
          <h2 class="text-base font-semibold" id="addonModalTitle">Novo Adicional</h2>
          <p class="text-xs" id="addonModalSubtitle" style="color: var(--text-muted);">Item: -</p>
        </div>
        <button onclick="closeAddonModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <form id="addonForm" onsubmit="saveAddon(event)">
          <input type="hidden" id="addonId"><input type="hidden" id="addonProductId">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Nome *</label>
                <input type="text" id="addonName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Usu√°rio Extra...">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">C√≥digo/SKU</label>
                <input type="text" id="addonSku" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="ADD-001">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Descri√ß√£o</label>
              <textarea id="addonDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="Descri√ß√£o do adicional..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Pre√ßo *</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm" style="color: var(--text-muted);">R$</span>
                  <input type="text" id="addonPrice" required class="w-full pl-10 pr-3 py-2.5 rounded-lg text-sm" placeholder="0,00" oninput="formatCurrencyInput(this)">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Ciclo</label>
                <select id="addonBillingCycle" class="w-full px-3 py-2.5 rounded-lg text-sm">
                  <option value="one_time">√önico</option><option value="monthly">Mensal</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="yearly">Anual</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Tipo</label>
                <select id="addonType" class="w-full px-3 py-2.5 rounded-lg text-sm">
                  <option value="addon">Adicional</option><option value="setup">Taxa de Setup</option><option value="support">Suporte</option>
                </select>
              </div>
              <div class="flex items-end pb-2.5">
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" id="addonRequired" class="w-4 h-4 rounded" style="accent-color: var(--primary);">
                  <span class="text-sm">Obrigat√≥rio</span>
                </label>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-2">Op√ß√µes Compat√≠veis</label>
              <div id="addonCompatiblePlans" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeAddonModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button type="submit" form="addonForm" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Categoria -->
  <div id="categoryModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeCategoryModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <h2 class="text-base font-semibold">Nova Categoria</h2>
        <button onclick="closeCategoryModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1.5">Nome da Categoria *</label>
            <input type="text" id="categoryName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Softwares, Servi√ßos...">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1.5">Descri√ß√£o</label>
            <textarea id="categoryDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="Breve descri√ß√£o..."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium mb-2">√çcone</label>
            <div class="flex items-center gap-4 mb-3">
              <div id="iconPreview" class="w-12 h-12 rounded-xl flex items-center justify-center icon-box">
                <svg class="w-6 h-6" id="previewSvg" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
              </div>
              <div class="text-xs" style="color: var(--text-muted);">
                <p class="font-medium text-dark mb-0.5">√çcone selecionado</p>
                <p id="selectedIconName">package</p>
              </div>
            </div>
            <div class="icon-grid p-1 border rounded-lg" style="border-color: var(--border);">
              <div class="icon-item" onclick="selectIcon('package')" title="package"><svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div>
              <div class="icon-item" onclick="selectIcon('layers')" title="layers"><svg class="w-5 h-5" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
              <div class="icon-item" onclick="selectIcon('cpu')" title="cpu"><svg class="w-5 h-5" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="15" x2="23" y2="15"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="15" x2="4" y2="15"/></svg></div>
              <div class="icon-item" onclick="selectIcon('cloud')" title="cloud"><svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg></div>
              <div class="icon-item" onclick="selectIcon('database')" title="database"><svg class="w-5 h-5" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg></div>
              <div class="icon-item" onclick="selectIcon('shield')" title="shield"><svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
              <div class="icon-item" onclick="selectIcon('users')" title="users"><svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div>
              <div class="icon-item" onclick="selectIcon('message-square')" title="message-square"><svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></div>
              <div class="icon-item" onclick="selectIcon('settings')" title="settings"><svg class="w-5 h-5" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></div>
              <div class="icon-item" onclick="selectIcon('headphones')" title="headphones"><svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg></div>
              <div class="icon-item" onclick="selectIcon('briefcase')" title="briefcase"><svg class="w-5 h-5" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
              <div class="icon-item" onclick="selectIcon('shopping-cart')" title="shopping-cart"><svg class="w-5 h-5" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg></div>
            </div>
            <input type="hidden" id="categoryIcon" value="package">
          </div>
        </div>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeCategoryModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button onclick="saveCategory()" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[100] hidden">
    <div class="bg-gray-900 text-white px-5 py-3 rounded-xl shadow-2xl flex items-center gap-3">
      <div class="w-5 h-5 rounded-full bg-green-500 flex items-center justify-center">
        <svg class="w-3 h-3 text-white" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <span id="toast-message" class="text-sm font-medium"></span>
    </div>
  </div>

  <script>
    var categories = [];
    var products = [];
    var selectedIcon = 'package';

    function renderCatalog() {
      var container = document.getElementById('catalogTree');
      if (!categories.length) {
        container.innerHTML = '<div class="flex flex-col items-center justify-center py-20 bg-white rounded-2xl border border-dashed" style="border-color: var(--border);"><div class="w-16 h-16 rounded-2xl flex items-center justify-center icon-box mb-4"><svg class="w-8 h-8" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg></div><h3 class="text-lg font-semibold mb-1">Cat√°logo vazio</h3><p class="text-sm mb-6" style="color: var(--text-muted);">Comece criando uma categoria.</p><button onclick="openCategoryModal()" class="btn-primary px-6 py-2.5 rounded-xl text-sm">Criar Categoria</button></div>';
        return;
      }
      
      container.innerHTML = categories.map(function(cat) {
        var catProducts = products.filter(function(p) { return p.category_id === cat.id; });
        return '<div class="card overflow-hidden"><div class="px-5 py-4 flex items-center justify-between category-header"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl flex items-center justify-center icon-box">' + getIconSvg(cat.icon, 'w-5 h-5') + '</div><div><h3 class="font-semibold text-sm">' + cat.name + '</h3><p class="text-xs" style="color: var(--text-muted);">' + (cat.description || 'Sem descri√ß√£o') + '</p></div></div><div class="flex items-center gap-2"><span class="badge badge-count">' + catProducts.length + ' itens</span><button onclick="deleteCategory(\'' + cat.id + '\')" class="p-2 rounded-lg hover:bg-red-50 text-red-500"><svg class="w-4 h-4" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg></button></div></div><div class="p-5 space-y-3">' + (catProducts.length ? catProducts.map(function(p) { return renderProductItem(p); }).join('') : '<p class="text-xs text-center py-4 italic" style="color: var(--text-muted);">Nenhum item nesta categoria</p>') + '<button onclick="openProductModal(null, \'' + cat.id + '\')" class="w-full py-3 border border-dashed rounded-xl text-xs font-medium hover:bg-gray-50 flex items-center justify-center gap-2" style="border-color: var(--border); color: var(--text-muted);"><svg class="w-3.5 h-3.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Adicionar Item</button></div></div>';
      }).join('');
    }

    function renderProductItem(p) {
      return '<div class="border rounded-xl p-4" style="border-color: var(--border);"><div class="flex items-start justify-between mb-4"><div><div class="flex items-center gap-2 mb-1"><h4 class="font-semibold text-sm">' + p.name + '</h4>' + (p.status === 'active' ? '<span class="badge badge-active">Ativo</span>' : '<span class="badge badge-inactive">Inativo</span>') + '</div><p class="text-xs" style="color: var(--text-muted);">' + (p.description || 'Sem descri√ß√£o') + '</p></div><div class="flex gap-1"><button onclick="editProduct(\'' + p.id + '\')" class="p-1.5 rounded hover:bg-gray-100" style="color: var(--text-muted);"><svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button onclick="deleteProduct(\'' + p.id + '\')" class="p-1.5 rounded hover:bg-red-50" style="color: var(--danger);"><svg class="w-4 h-4" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><div class="flex items-center justify-between mb-2"><span class="text-[11px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">Op√ß√µes de Pre√ßo</span><button onclick="openPlanModal(\'' + p.id + '\')" class="text-[11px] font-bold" style="color: var(--primary);">+ Adicionar</button></div><div class="space-y-2">' + (p.plans && p.plans.length ? p.plans.map(function(pl) { return '<div class="plan-card p-3 flex items-center justify-between"><div><p class="text-xs font-semibold">' + pl.name + '</p><p class="text-[11px]" style="color: var(--text-muted);">' + formatCurrency(pl.price) + (pl.billing_cycle !== 'one_time' ? '/' + getBillingLabelShort(pl.billing_cycle) : '') + '</p></div><div class="flex gap-1"><button onclick="editPlan(\'' + p.id + '\', \'' + pl.id + '\')" class="p-1 rounded hover:bg-white"><svg class="w-3.5 h-3.5" style="color: var(--text-muted);" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button onclick="deletePlan(\'' + p.id + '\', \'' + pl.id + '\')" class="p-1 rounded hover:bg-red-50"><svg class="w-3.5 h-3.5" style="color: var(--danger);" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div>'; }).join('') : '<p class="text-[11px] italic py-2" style="color: var(--text-muted);">Nenhuma op√ß√£o</p>') + '</div></div><div><div class="flex items-center justify-between mb-2"><span class="text-[11px] font-bold uppercase tracking-wider" style="color: var(--text-muted);">Adicionais e Taxas</span><button onclick="openAddonModal(\'' + p.id + '\')" class="text-[11px] font-bold" style="color: var(--primary);">+ Adicionar</button></div><div class="space-y-2">' + (p.addons && p.addons.length ? p.addons.map(function(ad) { return '<div class="addon-chip p-2.5 flex items-center justify-between ' + (ad.required ? 'required' : '') + '"><div><div class="flex items-center gap-1.5"><p class="text-[11px] font-semibold">' + ad.name + '</p>' + (ad.required ? '<span class="badge badge-required">Obrigat√≥rio</span>' : '') + '</div><p class="text-[10px]" style="color: var(--text-muted);">' + formatCurrency(ad.price) + '</p></div><div class="flex gap-1"><button onclick="editAddon(\'' + p.id + '\', \'' + ad.id + '\')" class="p-1 rounded hover:bg-white"><svg class="w-3.5 h-3.5" style="color: var(--text-muted);" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button onclick="deleteAddon(\'' + p.id + '\', \'' + ad.id + '\')" class="p-1 rounded hover:bg-red-50"><svg class="w-3.5 h-3.5" style="color: var(--danger);" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div></div>'; }).join('') : '<p class="text-[11px] italic py-2" style="color: var(--text-muted);">Nenhum adicional</p>') + '</div></div></div></div>';
    }

    function selectIcon(name) {
      selectedIcon = name;
      document.getElementById('categoryIcon').value = name;
      document.getElementById('selectedIconName').textContent = name;
      updateIconPreview();
      document.querySelectorAll('.icon-item').forEach(function(el) {
        el.classList.remove('selected');
        if (el.getAttribute('title') === name) el.classList.add('selected');
      });
    }

    function updateIconPreview() {
      var preview = document.getElementById('iconPreview');
      preview.innerHTML = getIconSvg(selectedIcon, 'w-6 h-6');
    }

    function getIconSvg(name, cls) {
      var icons = {
        'package': '<svg class="' + cls + '" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
        'layers': '<svg class="' + cls + '" viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>',
        'cpu': '<svg class="' + cls + '" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="15" x2="23" y2="15"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="15" x2="4" y2="15"/></svg>',
        'cloud': '<svg class="' + cls + '" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>',
        'database': '<svg class="' + cls + '" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
        'shield': '<svg class="' + cls + '" viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
        'users': '<svg class="' + cls + '" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        'message-square': '<svg class="' + cls + '" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
        'settings': '<svg class="' + cls + '" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
        'headphones': '<svg class="' + cls + '" viewBox="0 0 24 24"><path d="M3 18v-6a9 9 0 0 1 18 0v6"/><path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3zM3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/></svg>',
        'briefcase': '<svg class="' + cls + '" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
        'shopping-cart': '<svg class="' + cls + '" viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>'
      };
      return icons[name] || icons['package'];
    }
    
    function openCategoryModal(){document.getElementById('categoryModal').classList.remove('hidden');document.getElementById('categoryName').value='';document.getElementById('categoryDescription').value='';selectedIcon='package';document.getElementById('categoryIcon').value='package';updateIconPreview();document.getElementById('selectedIconName').textContent='package';}
    function closeCategoryModal(){document.getElementById('categoryModal').classList.add('hidden');}
    function saveCategory(){var n=document.getElementById('categoryName').value.trim();if(!n){alert('Informe o nome');return;}categories.push({id:'cat-'+Date.now(),name:n,description:document.getElementById('categoryDescription').value.trim(),icon:document.getElementById('categoryIcon').value});renderCatalog();closeCategoryModal();showToast('Categoria criada!');}
    function deleteCategory(id){if(products.some(function(p){return p.category_id===id;})){alert('Remova os itens primeiro.');return;}if(!confirm('Excluir?'))return;categories=categories.filter(function(c){return c.id!==id;});renderCatalog();showToast('Exclu√≠da!');}
    
    function openProductModal(id,catId){document.getElementById('productModal').classList.remove('hidden');document.getElementById('productForm').reset();document.getElementById('productId').value=id||'';populateCategorySelects();if(catId)document.getElementById('productCategory').value=catId;if(id){var p=products.find(function(x){return x.id===id;});if(p){document.getElementById('productModalTitle').textContent='Editar Item';document.getElementById('productName').value=p.name;document.getElementById('productDescription').value=p.description||'';document.getElementById('productSku').value=p.sku||'';document.getElementById('productStatus').value=p.status;document.getElementById('productCategory').value=p.category_id;}}else{document.getElementById('productModalTitle').textContent='Novo Item';}}
    function closeProductModal(){document.getElementById('productModal').classList.add('hidden');}
    function saveProduct(e){e.preventDefault();var id=document.getElementById('productId').value||'prod-'+Date.now();var isNew=!document.getElementById('productId').value;var d={id:id,category_id:document.getElementById('productCategory').value,name:document.getElementById('productName').value,description:document.getElementById('productDescription').value,sku:document.getElementById('productSku').value,status:document.getElementById('productStatus').value,plans:[],addons:[]};if(isNew)products.push(d);else{var i=products.findIndex(function(p){return p.id===id;});if(i>=0){d.plans=products[i].plans;d.addons=products[i].addons;products[i]=d;}}renderCatalog();closeProductModal();showToast(isNew?'Criado!':'Atualizado!');}
    function editProduct(id){openProductModal(id);}
    function deleteProduct(id){if(!confirm('Excluir item e op√ß√µes?'))return;products=products.filter(function(p){return p.id!==id;});renderCatalog();showToast('Exclu√≠do!');}
    
    function openPlanModal(prodId,planId){var prod=products.find(function(p){return p.id===prodId;});if(!prod)return;document.getElementById('planModal').classList.remove('hidden');document.getElementById('planForm').reset();document.getElementById('planId').value=planId||'';document.getElementById('planProductId').value=prodId;document.getElementById('planModalSubtitle').textContent='Item: '+prod.name;document.getElementById('planFeaturesList').innerHTML='';if(planId){var pl=prod.plans.find(function(x){return x.id===planId;});if(pl){document.getElementById('planModalTitle').textContent='Editar Op√ß√£o';document.getElementById('planName').value=pl.name;document.getElementById('planSku').value=pl.sku||'';document.getElementById('planDescription').value=pl.description||'';document.getElementById('planPrice').value=formatCurrencyValue(pl.price);document.getElementById('planBillingCycle').value=pl.billing_cycle;document.getElementById('planOrder').value=pl.order||'';(pl.features||[]).forEach(function(f){addPlanFeature(f);});}}else{document.getElementById('planModalTitle').textContent='Nova Op√ß√£o';document.getElementById('planOrder').value=(prod.plans||[]).length+1;}}
    function closePlanModal(){document.getElementById('planModal').classList.add('hidden');}
    function addPlanFeature(v){var c=document.getElementById('planFeaturesList');var d=document.createElement('div');d.className='flex items-center gap-2';d.innerHTML='<input type="text" class="plan-feature-input flex-1 px-3 py-2 rounded-lg text-sm" placeholder="Ex: 10 usu√°rios..." value="'+(v||'')+'"><button type="button" onclick="this.parentElement.remove()" class="p-1.5 rounded hover:bg-red-50" style="color:var(--danger);"><svg class="w-4 h-4" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>';c.appendChild(d);}
    function savePlan(e){e.preventDefault();var prodId=document.getElementById('planProductId').value;var planId=document.getElementById('planId').value||'plan-'+Date.now();var isNew=!document.getElementById('planId').value;var features=[];document.querySelectorAll('.plan-feature-input').forEach(function(i){if(i.value.trim())features.push(i.value.trim());});var d={id:planId,name:document.getElementById('planName').value,sku:document.getElementById('planSku').value,description:document.getElementById('planDescription').value,price:parseCurrency(document.getElementById('planPrice').value),billing_cycle:document.getElementById('planBillingCycle').value,order:parseInt(document.getElementById('planOrder').value)||1,features:features};var prod=products.find(function(p){return p.id===prodId;});if(prod){if(isNew){prod.plans=prod.plans||[];prod.plans.push(d);}else{var i=prod.plans.findIndex(function(x){return x.id===planId;});if(i>=0)prod.plans[i]=d;}}renderCatalog();closePlanModal();showToast(isNew?'Op√ß√£o criada!':'Atualizada!');}
    function editPlan(prodId,planId){openPlanModal(prodId,planId);}
    function deletePlan(prodId,planId){if(!confirm('Excluir?'))return;var p=products.find(function(x){return x.id===prodId;});if(p)p.plans=p.plans.filter(function(x){return x.id!==planId;});renderCatalog();showToast('Exclu√≠do!');}
    
    function openAddonModal(prodId,addonId){var prod=products.find(function(p){return p.id===prodId;});if(!prod)return;document.getElementById('addonModal').classList.remove('hidden');document.getElementById('addonForm').reset();document.getElementById('addonId').value=addonId||'';document.getElementById('addonProductId').value=prodId;document.getElementById('addonModalSubtitle').textContent='Item: '+prod.name;document.getElementById('addonCompatiblePlans').innerHTML=(prod.plans||[]).map(function(pl){return '<label class="flex items-center gap-2 px-2.5 py-1.5 rounded-lg cursor-pointer text-xs" style="background:var(--bg-page);border:1px solid var(--border);"><input type="checkbox" class="addon-plan-checkbox" value="'+pl.id+'" style="accent-color:var(--primary);"><span>'+pl.name+'</span></label>';}).join('');if(addonId){var ad=(prod.addons||[]).find(function(x){return x.id===addonId;});if(ad){document.getElementById('addonModalTitle').textContent='Editar Adicional';document.getElementById('addonName').value=ad.name;document.getElementById('addonSku').value=ad.sku||'';document.getElementById('addonDescription').value=ad.description||'';document.getElementById('addonPrice').value=formatCurrencyValue(ad.price);document.getElementById('addonBillingCycle').value=ad.billing_cycle;document.getElementById('addonType').value=ad.type||'addon';document.getElementById('addonRequired').checked=ad.required||false;(ad.compatible_plans||[]).forEach(function(plId){var cb=document.querySelector('.addon-plan-checkbox[value="'+plId+'"]');if(cb)cb.checked=true;});}}else{document.getElementById('addonModalTitle').textContent='Novo Adicional';}}
    function closeAddonModal(){document.getElementById('addonModal').classList.add('hidden');}
    function saveAddon(e){e.preventDefault();var prodId=document.getElementById('addonProductId').value;var addonId=document.getElementById('addonId').value||'addon-'+Date.now();var isNew=!document.getElementById('addonId').value;var compatible=[];document.querySelectorAll('.addon-plan-checkbox:checked').forEach(function(cb){compatible.push(cb.value);});var d={id:addonId,name:document.getElementById('addonName').value,sku:document.getElementById('addonSku').value,description:document.getElementById('addonDescription').value,price:parseCurrency(document.getElementById('addonPrice').value),billing_cycle:document.getElementById('addonBillingCycle').value,type:document.getElementById('addonType').value,compatible_plans:compatible,required:document.getElementById('addonRequired').checked};var prod=products.find(function(p){return p.id===prodId;});if(prod){if(isNew){prod.addons=prod.addons||[];prod.addons.push(d);}else{var i=prod.addons.findIndex(function(x){return x.id===addonId;});if(i>=0)prod.addons[i]=d;}}renderCatalog();closeAddonModal();showToast(isNew?'Criado!':'Atualizado!');}
    function editAddon(prodId,addonId){openAddonModal(prodId,addonId);}
    function deleteAddon(prodId,addonId){if(!confirm('Excluir?'))return;var p=products.find(function(x){return x.id===prodId;});if(p)p.addons=p.addons.filter(function(x){return x.id!==addonId;});renderCatalog();showToast('Exclu√≠do!');}
    
    function populateCategorySelects(){var s=document.getElementById('productCategory');if(s)s.innerHTML='<option value="">Selecione...</option>'+categories.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');}
    function formatCurrency(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);}
    function formatCurrencyValue(v){return (v||0).toFixed(2).replace('.',',');}
    function formatCurrencyInput(inp){var v=inp.value.replace(/\D/g,'');v=(parseInt(v||0)/100).toFixed(2);inp.value=v.replace('.',',');}
    function parseCurrency(v){if(!v)return 0;return parseFloat(v.toString().replace(/\./g,'').replace(',','.'))||0;}
    function getBillingLabel(c){var l={one_time:'Pagamento √∫nico',monthly:'Mensal',quarterly:'Trimestral',semiannual:'Semestral',yearly:'Anual'};return l[c]||c;}
    function getBillingLabelShort(c){var l={one_time:'',monthly:'m√™s',quarterly:'trim',semiannual:'sem',yearly:'ano'};return l[c]||c;}
    function showToast(msg){var t=document.getElementById('toast');document.getElementById('toast-message').textContent=msg;t.classList.remove('hidden');setTimeout(function(){t.classList.add('hidden');},3000);}
    
    document.addEventListener('DOMContentLoaded',function(){updateIconPreview();renderCatalog();});
  </script>

<script>
// Supabase Integration - Isolated script
(function() {
  const SB_URL = 'https://supabase.atenza.digital';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJhbm9uIiwKICAgICJpc3MiOiAic3VwYWJhc2UtZGVtbyIsCiAgICAiaWF0IjogMTY0MTc2OTIwMCwKICAgICJleHAiOiAxNzk5NTM1NjAwCn0.dc_X5iR_VP_qT0zsiyj_I_OZ2T9FtRU2BBNWN8Bu4GE';
  
  let sb, accUUID;
  
  async function initSupabase() {
    try {
      // Usando configura√ß√£o customizada para evitar o erro 401 do JWT
      sb = window.supabase.createClient(SB_URL, SB_KEY, {
        global: {
          headers: { 'Authorization': '' } // Remove o Bearer token que est√° causando 401
        }
      });
      const params = new URLSearchParams(window.location.search);
      const accId = params.get('id') || params.get('account_id') || 'teste-atenza-123';
      
      console.log('üîç Buscando conta para:', accId);
      let {data: acc, error: accError} = await sb.from('accounts').select('id').eq('helena_account_id', accId).maybeSingle();
      
      if (accError) {
        console.error('‚ùå Erro ao buscar conta:', accError);
        throw accError;
      }

      if (!acc) {
        console.log('‚ú® Criando nova conta para:', accId);
        let {data: newAcc, error: insertError} = await sb.from('accounts').insert([{
          helena_account_id: accId,
          name: 'Atenza',
          email: 'contato@atenza.digital'
        }]).select().single();
        
        if (insertError) {
          console.error('‚ùå Erro ao criar conta:', insertError);
          throw insertError;
        }
        acc = newAcc;
      }
      
      if (!acc) {
        throw new Error('N√£o foi poss√≠vel obter ou criar a conta.');
      }
      
      accUUID = acc.id;
      console.log('‚úÖ Account UUID:', accUUID);
      
      let {data: cats} = await sb.from('categories').select('*').eq('account_id', accUUID).order('display_order');
      if (cats && cats.length) {
        categories.length = 0;
        cats.forEach(c => categories.push({
          id: c.id,
          name: c.name,
          description: c.description || '',
          icon: c.icon || 'package'
        }));
      }
      
      let {data: prods} = await sb.from('products').select('*').eq('account_id', accUUID).order('display_order');
      if (prods && prods.length) {
        products.length = 0;
        for (let p of prods) {
          let {data: plans} = await sb.from('product_plans').select('*').eq('product_id', p.id).order('display_order');
          let {data: addons} = await sb.from('product_addons').select('*').eq('product_id', p.id).order('display_order');
          products.push({
            id: p.id,
            category_id: p.category_id,
            name: p.name,
            description: p.description || '',
            sku: p.sku || '',
            status: p.status || 'active',
            plans: (plans || []).map(pl => ({
              id: pl.id,
              name: pl.name,
              price: parseFloat(pl.price) || 0,
              billing_cycle: pl.billing_type || 'monthly',
              description: pl.description || '',
              features: []
            })),
            addons: (addons || []).map(ad => ({
              id: ad.id,
              name: ad.name,
              price: parseFloat(ad.price) || 0,
              type: 'addon'
            }))
          });
        }
      }
      
      renderCatalog();
      console.log('‚úÖ Dados carregados');
      
      const origSaveCat = window.saveCategory;
      window.saveCategory = async function() {
        const name = document.getElementById('categoryName').value.trim();
        if (!name) { alert('Nome obrigat√≥rio'); return; }
        try {
          const {data, error} = await sb.from('categories').insert([{
            account_id: accUUID,
            name: name,
            description: document.getElementById('categoryDescription').value.trim(),
            icon: document.getElementById('categoryIcon').value || 'package',
            display_order: categories.length
          }]).select().single();
          if (error) throw error;
          categories.push({
            id: data.id,
            name: data.name,
            description: data.description || '',
            icon: data.icon || 'package'
          });
          renderCatalog();
          closeCategoryModal();
          showToast('‚úÖ Categoria salva!');
        } catch(e) {
          console.error(e);
          alert('Erro: ' + e.message);
        }
      };
      
      const origDelCat = window.deleteCategory;
      window.deleteCategory = async function(id) {
        if (products.some(p => p.category_id === id)) {
          alert('Remova os produtos primeiro');
          return;
        }
        if (!confirm('Excluir categoria?')) return;
        try {
          await sb.from('categories').delete().eq('id', id);
          const idx = categories.findIndex(c => c.id === id);
          if (idx >= 0) categories.splice(idx, 1);
          renderCatalog();
          showToast('‚úÖ Categoria exclu√≠da!');
        } catch(e) {
          alert('Erro: ' + e.message);
        }
      };
      
      const origSaveProd = window.saveProduct;
      window.saveProduct = async function(e) {
        e.preventDefault();
        const id = document.getElementById('productId').value;
        const isNew = !id;
        const data = {
          category_id: document.getElementById('productCategory').value,
          name: document.getElementById('productName').value,
          description: document.getElementById('productDescription').value,
          sku: document.getElementById('productSku').value,
          status: document.getElementById('productStatus').value
        };
        try {
          if (isNew) {
            const {data: prod} = await sb.from('products').insert([{
              account_id: accUUID,
              ...data,
              type: 'service',
              display_order: products.length
            }]).select().single();
            products.push({
              id: prod.id,
              ...data,
              plans: [],
              addons: []
            });
          } else {
            await sb.from('products').update(data).eq('id', id);
            const idx = products.findIndex(p => p.id === id);
            if (idx >= 0) {
              products[idx] = {...products[idx], ...data};
            }
          }
          renderCatalog();
          closeProductModal();
          showToast(isNew ? '‚úÖ Produto criado!' : '‚úÖ Produto atualizado!');
        } catch(e) {
          alert('Erro: ' + e.message);
        }
      };
      
      const origDelProd = window.deleteProduct;
      window.deleteProduct = async function(id) {
        if (!confirm('Excluir produto?')) return;
        try {
          await sb.from('products').delete().eq('id', id);
          const idx = products.findIndex(p => p.id === id);
          if (idx >= 0) products.splice(idx, 1);
          renderCatalog();
          showToast('‚úÖ Produto exclu√≠do!');
        } catch(e) {
          alert('Erro: ' + e.message);
        }
      };
      
    } catch(e) {
      console.error('Erro Supabase:', e);
      alert('Erro ao conectar: ' + e.message);
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSupabase);
  } else {
    initSupabase();
  }
})();
</script>
</body>
</html>
