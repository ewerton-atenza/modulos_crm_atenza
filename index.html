<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Negócios - Catálogo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    :root {
      --primary: #3850A0;
      --primary-dark: #2A407E;
      --bg-page: #F8F9FA;
      --bg-card: #FFFFFF;
      --border: #E5E7EB;
      --text-dark: #1F2937;
      --text-muted: #9CA3AF;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
    }
    .btn-primary { background: var(--primary); color: white; font-weight: 500; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text-dark); }
    .btn-secondary:hover { background: var(--bg-page); }
    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
    .plan-card { background: var(--bg-page); border: 1px solid var(--border); border-radius: 10px; }
    .plan-card:hover { border-color: var(--primary); background: white; }
    .addon-chip { background: var(--bg-page); border: 1px solid var(--border); border-radius: 8px; }
    .addon-chip:hover { border-color: var(--primary); background: white; }
    .addon-chip.required { border-color: var(--warning); background: #FFFBEB; }
    .modal-backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
    input, select, textarea { background: white !important; border: 1px solid var(--border) !important; color: var(--text-dark) !important; }
    input:focus, select:focus, textarea:focus { border-color: var(--primary) !important; outline: none; }
    .category-header { background: linear-gradient(90deg, rgba(56, 80, 160, 0.05) 0%, transparent 100%); }
    .badge { font-size: 11px; font-weight: 500; padding: 4px 10px; border-radius: 20px; }
    .badge-active { background: #ECFDF5; color: #059669; }
    .badge-inactive { background: #F3F4F6; color: #6B7280; }
    .badge-required { background: #FEF3C7; color: #B45309; }
    .badge-setup { background: #FEF3C7; color: #B45309; }
    .badge-count { background: #EEF2FF; color: var(--primary); }
    .icon-box { background: #EEF2FF; color: var(--primary); }
    .collapse-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
    .collapse-content.open { max-height: 5000px; transition: max-height 0.5s ease-in; }
    .chevron { transition: transform 0.3s; }
    .chevron.open { transform: rotate(180deg); }
    .icon-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 300px; overflow-y: auto; }
    .icon-item { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
    .icon-item:hover { border-color: var(--primary); background: #EEF2FF; }
    .icon-item.selected { border-color: var(--primary); background: var(--primary); }
    .icon-item.selected svg { stroke: white; }
    svg { stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
  </style>
</head>
<body style="background: var(--bg-page); color: var(--text-dark); min-height: 100vh;">
  
  <header class="px-6 py-4 border-b" style="background: white; border-color: var(--border);">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-lg flex items-center justify-center icon-box">
          <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
        </div>
        <div>
          <h1 class="text-lg font-semibold">Catálogo</h1>
          <p class="text-xs" style="color: var(--text-muted);">Produtos, serviços e opções</p>
        </div>
      </div>
      <div class="flex gap-2">
        <button onclick="openCategoryModal()" class="btn-secondary flex items-center gap-2 px-4 py-2 rounded-lg text-sm">
          <svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Nova Categoria
        </button>
        <button onclick="openProductModal()" class="btn-primary flex items-center gap-2 px-4 py-2 rounded-lg text-sm">
          <svg class="w-4 h-4" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Novo Item
        </button>
      </div>
    </div>
  </header>
  
  <main class="p-6">
    <div class="space-y-4" id="catalogTree"></div>
  </main>
  
  <!-- Modal: Produto -->
  <div id="productModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeProductModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <h2 class="text-base font-semibold" id="productModalTitle">Novo Item</h2>
        <button onclick="closeProductModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <form id="productForm" onsubmit="saveProduct(event)">
          <input type="hidden" id="productId">
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1.5">Categoria *</label>
              <select id="productCategory" required class="w-full px-3 py-2.5 rounded-lg text-sm"><option value="">Selecione...</option></select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Nome *</label>
              <input type="text" id="productName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Sistema de Gestao...">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Descrição</label>
              <textarea id="productDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="Descrição..."></textarea>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Código/SKU</label>
                <input type="text" id="productSku" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="PROD-001">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Status</label>
                <select id="productStatus" class="w-full px-3 py-2.5 rounded-lg text-sm"><option value="active">Ativo</option><option value="inactive">Inativo</option></select>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeProductModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button type="submit" form="productForm" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Opção -->
  <div id="planModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closePlanModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <div>
          <h2 class="text-base font-semibold" id="planModalTitle">Nova Opção</h2>
          <p class="text-xs" id="planModalSubtitle" style="color: var(--text-muted);">Item: -</p>
        </div>
        <button onclick="closePlanModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <form id="planForm" onsubmit="savePlan(event)">
          <input type="hidden" id="planId"><input type="hidden" id="planProductId">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Nome *</label>
                <input type="text" id="planName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Basico...">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Código/SKU</label>
                <input type="text" id="planSku" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="OPC-001">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Descrição</label>
              <textarea id="planDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="O que esta incluido..."></textarea>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Preço *</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm" style="color: var(--text-muted);">R$</span>
                  <input type="text" id="planPrice" required class="w-full pl-10 pr-3 py-2.5 rounded-lg text-sm" placeholder="0,00" oninput="formatCurrencyInput(this)">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Ciclo</label>
                <select id="planBillingCycle" class="w-full px-3 py-2.5 rounded-lg text-sm">
                  <option value="one_time">Único</option><option value="monthly">Mensal</option><option value="quarterly">Trimestral</option><option value="semiannual">Semestral</option><option value="yearly">Anual</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Ordem</label>
                <input type="number" id="planOrder" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="1" min="1">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Itens Incluidos</label>
              <div id="planFeaturesList" class="space-y-2 mb-2"></div>
              <button type="button" onclick="addPlanFeature()" class="text-sm flex items-center gap-1" style="color: var(--primary);">
                <svg class="w-4 h-4" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Adicionar item
              </button>
            </div>
          </div>
        </form>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closePlanModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button type="submit" form="planForm" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Adicional -->
  <div id="addonModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeAddonModal()"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-lg rounded-xl overflow-hidden flex flex-col max-h-[90vh] bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <div>
          <h2 class="text-base font-semibold" id="addonModalTitle">Novo Adicional</h2>
          <p class="text-xs" id="addonModalSubtitle" style="color: var(--text-muted);">Item: -</p>
        </div>
        <button onclick="closeAddonModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-5">
        <form id="addonForm" onsubmit="saveAddon(event)">
          <input type="hidden" id="addonId"><input type="hidden" id="addonProductId">
          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Nome *</label>
                <input type="text" id="addonName" required class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Taxa Urgencia...">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Código/SKU</label>
                <input type="text" id="addonSku" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="ADD-001">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Descrição</label>
              <textarea id="addonDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="O que oferece..."></textarea>
            </div>
            <div class="grid grid-cols-3 gap-3">
              <div>
                <label class="block text-sm font-medium mb-1.5">Preço *</label>
                <div class="relative">
                  <span class="absolute left-3 top-1/2 -translate-y-1/2 text-sm" style="color: var(--text-muted);">R$</span>
                  <input type="text" id="addonPrice" required class="w-full pl-10 pr-3 py-2.5 rounded-lg text-sm" placeholder="0,00" oninput="formatCurrencyInput(this)">
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Ciclo</label>
                <select id="addonBillingCycle" class="w-full px-3 py-2.5 rounded-lg text-sm">
                  <option value="one_time">Único</option><option value="monthly">Mensal</option><option value="yearly">Anual</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1.5">Tipo</label>
                <select id="addonType" class="w-full px-3 py-2.5 rounded-lg text-sm">
                  <option value="addon">Adicional</option><option value="setup">Setup</option><option value="service">Serviço</option><option value="tax">Taxa</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1.5">Compativel com Opcoes</label>
              <div id="addonCompatiblePlans" class="flex flex-wrap gap-2"></div>
              <p class="text-xs mt-1.5" style="color: var(--text-muted);">Deixe em branco para todas</p>
            </div>
            <div class="flex items-center gap-3 p-3 rounded-lg" style="background: #FFFBEB;">
              <input type="checkbox" id="addonRequired" class="w-4 h-4 rounded" style="accent-color: var(--warning);">
              <label for="addonRequired" class="text-sm" style="color: #B45309;">Obrigatório na proposta</label>
            </div>
          </div>
        </form>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeAddonModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button type="submit" form="addonForm" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Categoria -->
  <div id="categoryModal" class="fixed inset-0 z-50 hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeCategoryModal()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md rounded-xl overflow-hidden bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <h2 class="text-base font-semibold">Nova Categoria</h2>
        <button onclick="closeCategoryModal()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="p-5 space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1.5">Nome *</label>
          <input type="text" id="categoryName" class="w-full px-3 py-2.5 rounded-lg text-sm" placeholder="Ex: Software, Serviços...">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Descrição</label>
          <textarea id="categoryDescription" rows="2" class="w-full px-3 py-2.5 rounded-lg text-sm resize-none" placeholder="Descrição..."></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1.5">Icone</label>
          <button type="button" onclick="openIconPicker()" class="w-full px-3 py-2.5 rounded-lg text-sm flex items-center gap-3 text-left" style="background: white; border: 1px solid var(--border);">
            <span id="selectedIconPreview" class="w-8 h-8 rounded-lg flex items-center justify-center icon-box"></span>
            <span id="selectedIconName">package</span>
            <svg class="w-4 h-4 ml-auto" style="color: var(--text-muted);" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg>
          </button>
          <input type="hidden" id="categoryIcon" value="package">
        </div>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeCategoryModal()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button onclick="saveCategory()" class="btn-primary px-4 py-2 rounded-lg text-sm">Criar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Icon Picker -->
  <div id="iconPickerModal" class="fixed inset-0 z-[60] hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeIconPicker()"></div>
    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md rounded-xl overflow-hidden bg-white shadow-xl">
      <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: var(--border);">
        <h2 class="text-base font-semibold">Selecione um Icone</h2>
        <button onclick="closeIconPicker()" class="p-1 rounded hover:bg-gray-100">
          <svg class="w-5 h-5" style="color: var(--text-muted);" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="p-5">
        <div class="relative mb-4">
          <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2" style="color: var(--text-muted);" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" id="iconSearch" class="w-full pl-10 pr-3 py-2.5 rounded-lg text-sm" placeholder="Pesquisar icones..." oninput="filterIcons(this.value)">
        </div>
        <div id="iconGrid" class="icon-grid"></div>
      </div>
      <div class="px-5 py-4 border-t flex justify-end gap-2" style="background: var(--bg-page); border-color: var(--border);">
        <button onclick="closeIconPicker()" class="btn-secondary px-4 py-2 rounded-lg text-sm">Cancelar</button>
        <button onclick="confirmIconSelection()" class="btn-primary px-4 py-2 rounded-lg text-sm">Salvar</button>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="px-4 py-3 rounded-lg flex items-center gap-2 shadow-lg" style="background: var(--text-dark); color: white;">
      <svg class="w-4 h-4" style="color: #34D399;" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
      <span id="toast-message" class="text-sm">Sucesso!</span>
    </div>
  </div>

  <script>
    const supabaseUrl = window.location.protocol + '//' + window.location.hostname;

    let currentAccount = null;

    async function fetchAccountData(helenaAccountId) {
      const url = `/api/catalog?id=${helenaAccountId}`;
      console.log('Fetching account data:', url);
      const response = await fetch(url);
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Erro ${response.status}: ${errorText}`);
      }
      return await response.json();
    }
    var ICONS = {
  // Negócios e Escritório
  briefcase: '<svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
  building: '<svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>',
  calculator: '<svg viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14.01"/><line x1="12" y1="14" x2="12" y2="14.01"/><line x1="8" y1="14" x2="8" y2="14.01"/><line x1="16" y1="18" x2="16" y2="18.01"/><line x1="12" y1="18" x2="12" y2="18.01"/><line x1="8" y1="18" x2="8" y2="18.01"/></svg>',
  clipboard: '<svg viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
  
  // Tecnologia e Software
  monitor: '<svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>',
  server: '<svg viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="8" rx="2" ry="2"/><rect x="2" y="14" width="20" height="8" rx="2" ry="2"/><line x1="6" y1="6" x2="6.01" y2="6"/><line x1="6" y1="18" x2="6.01" y2="18"/></svg>',
  database: '<svg viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
  cloud: '<svg viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>',
  cpu: '<svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"/><rect x="9" y="9" width="6" height="6"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/><line x1="9" y1="20" x2="9" y2="23"/><line x1="15" y1="20" x2="15" y2="23"/><line x1="20" y1="9" x2="23" y2="9"/><line x1="20" y1="14" x2="23" y2="14"/><line x1="1" y1="9" x2="4" y2="9"/><line x1="1" y1="14" x2="4" y2="14"/></svg>',
  smartphone: '<svg viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
  wifi: '<svg viewBox="0 0 24 24"><path d="M5 12.55a11 11 0 0 1 14.08 0"/><path d="M1.42 9a16 16 0 0 1 21.16 0"/><path d="M8.53 16.11a6 6 0 0 1 6.95 0"/><line x1="12" y1="20" x2="12.01" y2="20"/></svg>',
  
  // Produtos e Serviços
  package: '<svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
  box: '<svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>',
  shoppingBag: '<svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>',
  cart: '<svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>',
  tag: '<svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>',
  gift: '<svg viewBox="0 0 24 24"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>',
  
  // Comunicação
  mail: '<svg viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
  phone: '<svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
  messageCircle: '<svg viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>',
  send: '<svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>',
  
  // Pessoas e Equipe
  users: '<svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
  user: '<svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
  userCheck: '<svg viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>',
  
  // Saúde e Bem-estar
  heart: '<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
  activity: '<svg viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
  thermometer: '<svg viewBox="0 0 24 24"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
  
  // Educação
  book: '<svg viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>',
  bookOpen: '<svg viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>',
  graduationCap: '<svg viewBox="0 0 24 24"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>',
  
  // Transporte e Logística
  truck: '<svg viewBox="0 0 24 24"><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
  plane: '<svg viewBox="0 0 24 24"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>',
  ship: '<svg viewBox="0 0 24 24"><path d="M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"/><path d="M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76"/><path d="M19 13V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6"/><path d="M12 10v4"/><path d="M12 2v3"/></svg>',
  
  // Alimentação
  coffee: '<svg viewBox="0 0 24 24"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>',
  utensils: '<svg viewBox="0 0 24 24"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>',
  
  // Casa e Imóveis
  home: '<svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
  key: '<svg viewBox="0 0 24 24"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>',
  
  // Ferramentas e Configurações
  settings: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
  tool: '<svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  wrench: '<svg viewBox="0 0 24 24"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
  
  // Segurança
  shield: '<svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
  lock: '<svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
  unlock: '<svg viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',
  
  // Mídia e Entretenimento
  camera: '<svg viewBox="0 0 24 24"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>',
  video: '<svg viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>',
  music: '<svg viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
  
  // Finanças
  dollarSign: '<svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
  creditCard: '<svg viewBox="0 0 24 24"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>',
  trendingUp: '<svg viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
  
  // Outros
  globe: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>',
  star: '<svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
  zap: '<svg viewBox="0 0 24 24"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  award: '<svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>',
  target: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
  calendar: '<svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
  clock: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
  layers: '<svg viewBox="0 0 24 24"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>',
  file: '<svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
  folder: '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
  droplet: '<svg viewBox="0 0 24 24"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>',
  umbrella: '<svg viewBox="0 0 24 24"><path d="M23 12a11.05 11.05 0 0 0-22 0zm-5 7a3 3 0 0 1-6 0v-7"/></svg>'
};
    
    var iconList = [
  // Negócios e Escritório
  {name:'briefcase', label:'Maleta', tags:['negocios','trabalho','escritorio']},
  {name:'building', label:'Prédio', tags:['empresa','escritorio','corporativo']},
  {name:'calculator', label:'Calculadora', tags:['financas','contabilidade','matematica']},
  {name:'clipboard', label:'Prancheta', tags:['lista','tarefas','documentos']},
  
  // Tecnologia e Software
  {name:'monitor', label:'Monitor', tags:['tecnologia','computador','tela']},
  {name:'server', label:'Servidor', tags:['tecnologia','hospedagem','infraestrutura']},
  {name:'database', label:'Banco de Dados', tags:['dados','armazenamento','sql']},
  {name:'cloud', label:'Nuvem', tags:['saas','armazenamento','internet']},
  {name:'cpu', label:'Processador', tags:['hardware','computacao','tecnologia']},
  {name:'smartphone', label:'Celular', tags:['mobile','telefone','app']},
  {name:'wifi', label:'WiFi', tags:['internet','conexao','rede']},
  
  // Produtos e Serviços
  {name:'package', label:'Pacote', tags:['produto','caixa','entrega']},
  {name:'box', label:'Caixa', tags:['produto','embalagem','estoque']},
  {name:'shoppingBag', label:'Sacola', tags:['compras','varejo','loja']},
  {name:'cart', label:'Carrinho', tags:['compras','ecommerce','loja']},
  {name:'tag', label:'Etiqueta', tags:['preco','desconto','promocao']},
  {name:'gift', label:'Presente', tags:['brinde','bonus','promocao']},
  
  // Comunicação
  {name:'mail', label:'Email', tags:['mensagem','contato','comunicacao']},
  {name:'phone', label:'Telefone', tags:['contato','ligacao','suporte']},
  {name:'messageCircle', label:'Mensagem', tags:['chat','conversa','suporte']},
  {name:'send', label:'Enviar', tags:['mensagem','email','comunicacao']},
  
  // Pessoas e Equipe
  {name:'users', label:'Usuários', tags:['pessoas','equipe','grupo']},
  {name:'user', label:'Usuário', tags:['pessoa','perfil','conta']},
  {name:'userCheck', label:'Usuário Verificado', tags:['aprovado','validado','certificado']},
  
  // Saúde e Bem-estar
  {name:'heart', label:'Coração', tags:['saude','bem-estar','favorito']},
  {name:'activity', label:'Atividade', tags:['saude','fitness','exercicio']},
  {name:'thermometer', label:'Termômetro', tags:['temperatura','saude','clima']},
  
  // Educação
  {name:'book', label:'Livro', tags:['educacao','leitura','curso']},
  {name:'bookOpen', label:'Livro Aberto', tags:['estudo','leitura','aprendizado']},
  {name:'graduationCap', label:'Formatura', tags:['educacao','diploma','curso']},
  
  // Transporte e Logística
  {name:'truck', label:'Caminhão', tags:['transporte','entrega','logistica']},
  {name:'plane', label:'Avião', tags:['viagem','transporte','internacional']},
  {name:'ship', label:'Navio', tags:['maritimo','transporte','carga']},
  
  // Alimentação
  {name:'coffee', label:'Café', tags:['alimentacao','bebida','restaurante']},
  {name:'utensils', label:'Talheres', tags:['restaurante','comida','gastronomia']},
  
  // Casa e Imóveis
  {name:'home', label:'Casa', tags:['imovel','residencia','moradia']},
  {name:'key', label:'Chave', tags:['imovel','acesso','seguranca']},
  
  // Ferramentas e Configurações
  {name:'settings', label:'Configurações', tags:['ajustes','opcoes','personalizar']},
  {name:'tool', label:'Ferramenta', tags:['servico','manutencao','reparo']},
  {name:'wrench', label:'Chave Inglesa', tags:['manutencao','reparo','mecanica']},
  
  // Segurança
  {name:'shield', label:'Escudo', tags:['protecao','seguranca','defesa']},
  {name:'lock', label:'Cadeado', tags:['seguranca','privacidade','protegido']},
  {name:'unlock', label:'Desbloqueado', tags:['acesso','aberto','liberado']},
  
  // Mídia e Entretenimento
  {name:'camera', label:'Câmera', tags:['foto','video','midia']},
  {name:'video', label:'Vídeo', tags:['filmagem','midia','streaming']},
  {name:'music', label:'Música', tags:['audio','som','entretenimento']},
  
  // Finanças
  {name:'dollarSign', label:'Dinheiro', tags:['financas','pagamento','preco']},
  {name:'creditCard', label:'Cartão', tags:['pagamento','financas','credito']},
  {name:'trendingUp', label:'Crescimento', tags:['vendas','lucro','sucesso']},
  
  // Outros
  {name:'globe', label:'Globo', tags:['internet','mundial','internacional']},
  {name:'star', label:'Estrela', tags:['favorito','destaque','premium']},
  {name:'zap', label:'Raio', tags:['energia','rapido','potencia']},
  {name:'award', label:'Prêmio', tags:['conquista','certificado','medalha']},
  {name:'target', label:'Alvo', tags:['meta','objetivo','foco']},
  {name:'calendar', label:'Calendário', tags:['agenda','data','evento']},
  {name:'clock', label:'Relógio', tags:['tempo','horario','prazo']},
  {name:'layers', label:'Camadas', tags:['organizacao','estrutura','niveis']},
  {name:'file', label:'Arquivo', tags:['documento','pdf','texto']},
  {name:'folder', label:'Pasta', tags:['organizacao','arquivos','documentos']},
  {name:'droplet', label:'Gota', tags:['agua','limpeza','liquido']},
  {name:'umbrella', label:'Guarda-chuva', tags:['protecao','chuva','clima']}
];
    
    var selectedIcon = 'package';
    var tempSelectedIcon = 'package';
    var collapsedCategories = {};
    var collapsedProducts = {};
    
    var categories = [];
    var products = [];

    async function initializeApp() {
      const urlParams = new URLSearchParams(window.location.search);
      const helenaAccountId = urlParams.get('id');

      if (!helenaAccountId) {
        document.getElementById('catalogTree').innerHTML = '<div class="card p-10 text-center"><h3 class="text-lg font-medium">ID da conta não fornecido.</h3></div>';
        return;
      }

      console.log(`Buscando conta com helena_account_id: ${helenaAccountId}`);
      try {
        const data = await fetchAccountData(helenaAccountId);
        console.log('Dados recebidos:', data);
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        currentAccount = data.account;
        categories = data.categories || [];
        products = data.products || [];
        
        console.log('Conta:', currentAccount);
        console.log('Categorias:', categories.length);
        console.log('Produtos:', products.length);
        
        renderCatalog();
      } catch (err) {
        console.error('Erro na inicializacao:', err);
        document.getElementById('catalogTree').innerHTML = '<div class="card p-10 text-center"><h3 class="text-lg font-medium">Erro ao conectar</h3><p class="text-sm text-gray-500">' + err.message + '</p></div>';
      }
    }
    
    function icon(name,cls){cls=cls||'w-4 h-4';var svg=ICONS[name]||ICONS.package;return '<span class="inline-flex '+cls+'">'+svg+'</span>';}
    function chevron(open){return '<span class="chevron '+(open?'open':'')+'" style="color:var(--text-muted);"><svg class="w-4 h-4" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg></span>';}
    
    function openIconPicker(){tempSelectedIcon=selectedIcon;document.getElementById('iconPickerModal').classList.remove('hidden');document.getElementById('iconSearch').value='';renderIconGrid();}
    function closeIconPicker(){document.getElementById('iconPickerModal').classList.add('hidden');}
    function renderIconGrid(filter){
      var grid=document.getElementById('iconGrid');
      var filtered=filter?iconList.filter(function(i){return i.name.indexOf(filter.toLowerCase())>=0||i.tags.some(function(t){return t.indexOf(filter.toLowerCase())>=0;});}):iconList;
      grid.innerHTML=filtered.map(function(ic){var sel=tempSelectedIcon===ic.name;return '<div class="icon-item '+(sel?'selected':'')+'" onclick="selectIcon(\''+ic.name+'\')" title="'+ic.name+'">'+icon(ic.name,'w-5 h-5')+'</div>';}).join('');
    }
    function filterIcons(v){renderIconGrid(v);}
    function selectIcon(name){tempSelectedIcon=name;renderIconGrid(document.getElementById('iconSearch').value);}
    function confirmIconSelection(){selectedIcon=tempSelectedIcon;document.getElementById('categoryIcon').value=selectedIcon;document.getElementById('selectedIconPreview').innerHTML=icon(selectedIcon,'w-5 h-5');document.getElementById('selectedIconName').textContent=selectedIcon;closeIconPicker();}
    function updateIconPreview(){document.getElementById('selectedIconPreview').innerHTML=icon(selectedIcon,'w-5 h-5');}
    
    function toggleCategory(catId){collapsedCategories[catId]=!collapsedCategories[catId];renderCatalog();}
    function toggleProduct(prodId){collapsedProducts[prodId]=!collapsedProducts[prodId];renderCatalog();}
    
    function renderCatalog(){
      var container=document.getElementById('catalogTree');
      var html=categories.map(function(cat){
        var catProducts=products.filter(function(p){return p.category_id===cat.id;});
        var isCollapsed=collapsedCategories[cat.id];
        return '<div class="card overflow-hidden">'+
          '<div class="category-header px-5 py-3 flex items-center justify-between border-b cursor-pointer" style="border-color:var(--border);" onclick="toggleCategory(\''+cat.id+'\')">'+
            '<div class="flex items-center gap-3">'+
              chevron(!isCollapsed)+
              '<span class="w-8 h-8 rounded-lg flex items-center justify-center icon-box">'+icon(cat.icon||'package','w-4 h-4')+'</span>'+
              '<div><h2 class="text-sm font-semibold">'+cat.name+'</h2><p class="text-xs" style="color:var(--text-muted);">'+(cat.description||'')+'</p></div>'+
            '</div>'+
            '<div class="flex items-center gap-2" onclick="event.stopPropagation();">'+
              '<span class="badge badge-count">'+catProducts.length+' item(s)</span>'+
              '<button onclick="deleteCategory(\''+cat.id+'\')" class="p-1.5 rounded hover:bg-red-50 opacity-50 hover:opacity-100" style="color:var(--danger);"><svg class="w-4 h-4" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>'+
            '</div>'+
          '</div>'+
          '<div class="collapse-content '+(isCollapsed?'':'open')+'">'+
            catProducts.map(function(p){return renderProduct(p);}).join('')+
            (catProducts.length===0?'<div class="px-5 py-10 text-center" style="color:var(--text-muted);"><p class="text-sm">Nenhum item</p><button onclick="openProductModal(null,\''+cat.id+'\')" class="mt-2 text-sm hover:underline" style="color:var(--primary);">+ Adicionar</button></div>':'')+
          '</div>'+
        '</div>';
      }).join('');
      container.innerHTML=html||'<div class="card p-10 text-center"><div class="w-12 h-12 mx-auto mb-3 rounded-lg flex items-center justify-center icon-box">'+icon('package','w-6 h-6')+'</div><h3 class="text-sm font-medium mb-1">Catálogo vazio</h3><p class="text-xs mb-3" style="color:var(--text-muted);">Comece criando uma categoria.</p><button onclick="openCategoryModal()" class="btn-primary px-4 py-2 rounded-lg text-sm">Criar Categoria</button></div>';
      populateCategorySelects();
    }
    
    function renderProduct(p){
      var plans=(p.plans||[]).slice().sort(function(a,b){return a.order-b.order;});
      var isCollapsed=collapsedProducts[p.id];
      return '<div class="border-t" style="border-color:var(--border);">'+
        '<div class="px-5 py-3 flex items-center justify-between cursor-pointer hover:bg-gray-50" onclick="toggleProduct(\''+p.id+'\')">'+
          '<div class="flex items-center gap-3">'+
            chevron(!isCollapsed)+
            '<div class="w-8 h-8 rounded-lg flex items-center justify-center icon-box">'+icon('box','w-4 h-4')+'</div>'+
            '<div><h3 class="text-sm font-semibold">'+p.name+'</h3><p class="text-xs" style="color:var(--text-muted);">'+(p.description||'')+'</p></div>'+
          '</div>'+
          '<div class="flex items-center gap-2" onclick="event.stopPropagation();">'+
            '<span class="badge '+(p.status==='active'?'badge-active':'badge-inactive')+'">'+(p.status==='active'?'Ativo':'Inativo')+'</span>'+
            '<button onclick="editProduct(\''+p.id+'\')" class="p-1.5 rounded hover:bg-blue-50 opacity-50 hover:opacity-100" style="color:var(--primary);"><svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>'+
            '<button onclick="deleteProduct(\''+p.id+'\')" class="p-1.5 rounded hover:bg-red-50 opacity-50 hover:opacity-100" style="color:var(--danger);"><svg class="w-4 h-4" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>'+
          '</div>'+
        '</div>'+
        '<div class="collapse-content '+(isCollapsed?'':'open')+'">'+
          '<div class="px-5 pb-4 pt-1 pl-14">'+
            '<div class="mb-4">'+
              '<div class="flex items-center justify-between mb-2">'+
                '<h4 class="text-xs font-medium" style="color:var(--text-muted);">Opcoes ('+plans.length+')</h4>'+
                '<button onclick="openPlanModal(\''+p.id+'\')" class="text-xs flex items-center gap-1" style="color:var(--primary);"><svg class="w-3 h-3" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Nova</button>'+
              '</div>'+
              '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2">'+
                plans.map(function(pl){
                  return '<div class="plan-card relative p-3 cursor-pointer" onclick="editPlan(\''+p.id+'\',\''+pl.id+'\')">'+
                    '<h5 class="font-medium text-xs mb-0.5">'+pl.name+'</h5>'+
                    '<p class="text-base font-bold" style="color:var(--primary);">'+formatCurrency(pl.price)+'</p>'+
                    '<p class="text-[10px]" style="color:var(--text-muted);">'+getBillingLabel(pl.billing_cycle)+'</p>'+
                    (pl.features&&pl.features.length?'<ul class="mt-1.5 space-y-0.5">'+pl.features.slice(0,2).map(function(f){return '<li class="text-[10px]" style="color:var(--text-muted);"><span style="color:var(--success);">✓</span> '+f+'</li>';}).join('')+'</ul>':'')+
                    '<button onclick="event.stopPropagation();deletePlan(\''+p.id+'\',\''+pl.id+'\')" class="absolute top-1 right-1 p-1 rounded opacity-0 hover:opacity-100" style="color:var(--danger);"><svg class="w-3 h-3" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'+
                  '</div>';
                }).join('')+
              '</div>'+
            '</div>'+
            '<div>'+
              '<div class="flex items-center justify-between mb-2">'+
                '<h4 class="text-xs font-medium" style="color:var(--text-muted);">Adicionais ('+(p.addons||[]).length+')</h4>'+
                '<button onclick="openAddonModal(\''+p.id+'\')" class="text-xs flex items-center gap-1" style="color:var(--success);"><svg class="w-3 h-3" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Novo</button>'+
              '</div>'+
              '<div class="flex flex-wrap gap-2">'+
                (p.addons||[]).map(function(ad){
                  return '<div class="addon-chip '+(ad.required?'required':'')+' flex items-center gap-2 px-2.5 py-1.5 cursor-pointer" onclick="editAddon(\''+p.id+'\',\''+ad.id+'\')">'+
                    '<span class="text-xs font-medium">'+ad.name+'</span>'+
                    '<span class="text-xs font-semibold" style="color:'+(ad.billing_cycle==='one_time'?'var(--warning)':'var(--success)')+';">'+formatCurrency(ad.price)+(ad.billing_cycle!=='one_time'?'/'+getBillingLabelShort(ad.billing_cycle):'')+'</span>'+
                    (ad.required?'<span class="badge badge-required text-[10px] py-0.5 px-1.5">Obrig.</span>':'')+
                    (ad.type==='setup'?'<span class="badge badge-setup text-[10px] py-0.5 px-1.5">Setup</span>':'')+
                    '<button onclick="event.stopPropagation();deleteAddon(\''+p.id+'\',\''+ad.id+'\')" class="opacity-30 hover:opacity-100" style="color:var(--danger);"><svg class="w-3 h-3" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'+
                  '</div>';
                }).join('')+
                ((p.addons||[]).length===0?'<span class="text-xs italic" style="color:var(--text-muted);">Nenhum</span>':'')+
              '</div>'+
            '</div>'+
          '</div>'+
        '</div>'+
      '</div>';
    }
    
    function openCategoryModal(){document.getElementById('categoryModal').classList.remove('hidden');document.getElementById('categoryName').value='';document.getElementById('categoryDescription').value='';selectedIcon='package';document.getElementById('categoryIcon').value='package';updateIconPreview();document.getElementById('selectedIconName').textContent='package';}
    function closeCategoryModal(){document.getElementById('categoryModal').classList.add('hidden');}
    function saveCategory(){var n=document.getElementById('categoryName').value.trim();if(!n){alert('Informe o nome');return;}categories.push({id:'cat-'+Date.now(),name:n,description:document.getElementById('categoryDescription').value.trim(),icon:document.getElementById('categoryIcon').value});renderCatalog();closeCategoryModal();showToast('Categoria criada!');}
    function deleteCategory(id){if(products.some(function(p){return p.category_id===id;})){alert('Remova os itens primeiro.');return;}if(!confirm('Excluir?'))return;categories=categories.filter(function(c){return c.id!==id;});renderCatalog();showToast('Excluida!');}
    
    function openProductModal(id,catId){document.getElementById('productModal').classList.remove('hidden');document.getElementById('productForm').reset();document.getElementById('productId').value=id||'';populateCategorySelects();if(catId)document.getElementById('productCategory').value=catId;if(id){var p=products.find(function(x){return x.id===id;});if(p){document.getElementById('productModalTitle').textContent='Editar Item';document.getElementById('productName').value=p.name;document.getElementById('productDescription').value=p.description||'';document.getElementById('productSku').value=p.sku||'';document.getElementById('productStatus').value=p.status;document.getElementById('productCategory').value=p.category_id;}}else{document.getElementById('productModalTitle').textContent='Novo Item';}}
    function closeProductModal(){document.getElementById('productModal').classList.add('hidden');}
    function saveProduct(e){e.preventDefault();var id=document.getElementById('productId').value||'prod-'+Date.now();var isNew=!document.getElementById('productId').value;var d={id:id,category_id:document.getElementById('productCategory').value,name:document.getElementById('productName').value,description:document.getElementById('productDescription').value,sku:document.getElementById('productSku').value,status:document.getElementById('productStatus').value,plans:[],addons:[]};if(isNew)products.push(d);else{var i=products.findIndex(function(p){return p.id===id;});if(i>=0){d.plans=products[i].plans;d.addons=products[i].addons;products[i]=d;}}renderCatalog();closeProductModal();showToast(isNew?'Criado!':'Atualizado!');}
    function editProduct(id){openProductModal(id);}
    function deleteProduct(id){if(!confirm('Excluir item e opções?'))return;products=products.filter(function(p){return p.id!==id;});renderCatalog();showToast('Excluido!');}
    
    function openPlanModal(prodId,planId){var prod=products.find(function(p){return p.id===prodId;});if(!prod)return;document.getElementById('planModal').classList.remove('hidden');document.getElementById('planForm').reset();document.getElementById('planId').value=planId||'';document.getElementById('planProductId').value=prodId;document.getElementById('planModalSubtitle').textContent='Item: '+prod.name;document.getElementById('planFeaturesList').innerHTML='';if(planId){var pl=prod.plans.find(function(x){return x.id===planId;});if(pl){document.getElementById('planModalTitle').textContent='Editar Opção';document.getElementById('planName').value=pl.name;document.getElementById('planSku').value=pl.sku||'';document.getElementById('planDescription').value=pl.description||'';document.getElementById('planPrice').value=formatCurrencyValue(pl.price);document.getElementById('planBillingCycle').value=pl.billing_cycle;document.getElementById('planOrder').value=pl.order||'';(pl.features||[]).forEach(function(f){addPlanFeature(f);});}}else{document.getElementById('planModalTitle').textContent='Nova Opção';document.getElementById('planOrder').value=(prod.plans||[]).length+1;}}
    function closePlanModal(){document.getElementById('planModal').classList.add('hidden');}
    function addPlanFeature(v){var c=document.getElementById('planFeaturesList');var d=document.createElement('div');d.className='flex items-center gap-2';d.innerHTML='<input type="text" class="plan-feature-input flex-1 px-3 py-2 rounded-lg text-sm" placeholder="Ex: 10 usuarios..." value="'+(v||'')+'"><button type="button" onclick="this.parentElement.remove()" class="p-1.5 rounded hover:bg-red-50" style="color:var(--danger);"><svg class="w-4 h-4" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>';c.appendChild(d);}
    function savePlan(e){e.preventDefault();var prodId=document.getElementById('planProductId').value;var planId=document.getElementById('planId').value||'plan-'+Date.now();var isNew=!document.getElementById('planId').value;var features=[];document.querySelectorAll('.plan-feature-input').forEach(function(i){if(i.value.trim())features.push(i.value.trim());});var d={id:planId,name:document.getElementById('planName').value,sku:document.getElementById('planSku').value,description:document.getElementById('planDescription').value,price:parseCurrency(document.getElementById('planPrice').value),billing_cycle:document.getElementById('planBillingCycle').value,order:parseInt(document.getElementById('planOrder').value)||1,features:features};var prod=products.find(function(p){return p.id===prodId;});if(prod){if(isNew){prod.plans=prod.plans||[];prod.plans.push(d);}else{var i=prod.plans.findIndex(function(x){return x.id===planId;});if(i>=0)prod.plans[i]=d;}}renderCatalog();closePlanModal();showToast(isNew?'Opção criada!':'Atualizada!');}
    function editPlan(prodId,planId){openPlanModal(prodId,planId);}
    function deletePlan(prodId,planId){if(!confirm('Excluir?'))return;var p=products.find(function(x){return x.id===prodId;});if(p)p.plans=p.plans.filter(function(x){return x.id!==planId;});renderCatalog();showToast('Excluido!');}
    
    function openAddonModal(prodId,addonId){var prod=products.find(function(p){return p.id===prodId;});if(!prod)return;document.getElementById('addonModal').classList.remove('hidden');document.getElementById('addonForm').reset();document.getElementById('addonId').value=addonId||'';document.getElementById('addonProductId').value=prodId;document.getElementById('addonModalSubtitle').textContent='Item: '+prod.name;document.getElementById('addonCompatiblePlans').innerHTML=(prod.plans||[]).map(function(pl){return '<label class="flex items-center gap-2 px-2.5 py-1.5 rounded-lg cursor-pointer text-xs" style="background:var(--bg-page);border:1px solid var(--border);"><input type="checkbox" class="addon-plan-checkbox" value="'+pl.id+'" style="accent-color:var(--primary);"><span>'+pl.name+'</span></label>';}).join('');if(addonId){var ad=(prod.addons||[]).find(function(x){return x.id===addonId;});if(ad){document.getElementById('addonModalTitle').textContent='Editar Adicional';document.getElementById('addonName').value=ad.name;document.getElementById('addonSku').value=ad.sku||'';document.getElementById('addonDescription').value=ad.description||'';document.getElementById('addonPrice').value=formatCurrencyValue(ad.price);document.getElementById('addonBillingCycle').value=ad.billing_cycle;document.getElementById('addonType').value=ad.type||'addon';document.getElementById('addonRequired').checked=ad.required||false;(ad.compatible_plans||[]).forEach(function(plId){var cb=document.querySelector('.addon-plan-checkbox[value="'+plId+'"]');if(cb)cb.checked=true;});}}else{document.getElementById('addonModalTitle').textContent='Novo Adicional';}}
    function closeAddonModal(){document.getElementById('addonModal').classList.add('hidden');}
    function saveAddon(e){e.preventDefault();var prodId=document.getElementById('addonProductId').value;var addonId=document.getElementById('addonId').value||'addon-'+Date.now();var isNew=!document.getElementById('addonId').value;var compatible=[];document.querySelectorAll('.addon-plan-checkbox:checked').forEach(function(cb){compatible.push(cb.value);});var d={id:addonId,name:document.getElementById('addonName').value,sku:document.getElementById('addonSku').value,description:document.getElementById('addonDescription').value,price:parseCurrency(document.getElementById('addonPrice').value),billing_cycle:document.getElementById('addonBillingCycle').value,type:document.getElementById('addonType').value,compatible_plans:compatible,required:document.getElementById('addonRequired').checked};var prod=products.find(function(p){return p.id===prodId;});if(prod){if(isNew){prod.addons=prod.addons||[];prod.addons.push(d);}else{var i=prod.addons.findIndex(function(x){return x.id===addonId;});if(i>=0)prod.addons[i]=d;}}renderCatalog();closeAddonModal();showToast(isNew?'Criado!':'Atualizado!');}
    function editAddon(prodId,addonId){openAddonModal(prodId,addonId);}
    function deleteAddon(prodId,addonId){if(!confirm('Excluir?'))return;var p=products.find(function(x){return x.id===prodId;});if(p)p.addons=p.addons.filter(function(x){return x.id!==addonId;});renderCatalog();showToast('Excluido!');}
    
    function populateCategorySelects(){var s=document.getElementById('productCategory');if(s)s.innerHTML='<option value="">Selecione...</option>'+categories.map(function(c){return '<option value="'+c.id+'">'+c.name+'</option>';}).join('');}
    function formatCurrency(v){return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);}
    function formatCurrencyValue(v){return (v||0).toFixed(2).replace('.',',');}
    function formatCurrencyInput(inp){var v=inp.value.replace(/\D/g,'');v=(parseInt(v||0)/100).toFixed(2);inp.value=v.replace('.',',');}
    function parseCurrency(v){if(!v)return 0;return parseFloat(v.toString().replace(/\./g,'').replace(',','.'))||0;}
    function getBillingLabel(c){var l={one_time:'Pagamento unico',monthly:'Mensal',quarterly:'Trimestral',semiannual:'Semestral',yearly:'Anual'};return l[c]||c;}
    function getBillingLabelShort(c){var l={one_time:'',monthly:'mes',quarterly:'trim',semiannual:'sem',yearly:'ano'};return l[c]||c;}
    function showToast(msg){var t=document.getElementById('toast');document.getElementById('toast-message').textContent=msg;t.classList.remove('hidden');setTimeout(function(){t.classList.add('hidden');},3000);}
    
    // Expor funções globalmente para os botões HTML
    window.toggleCategory = (catId) => { collapsedCategories[catId] = !collapsedCategories[catId]; renderCatalog(); }
    window.toggleProduct = (prodId) => { collapsedProducts[prodId] = !collapsedProducts[prodId]; renderCatalog(); }
    window.openCategoryModal = openCategoryModal;
    window.closeProductModal = closeProductModal;
    window.openProductModal = openProductModal;
    window.deleteCategory = deleteCategory;
    window.deleteProduct = deleteProduct;
    window.openPlanModal = openPlanModal;
    window.closePlanModal = closePlanModal;
    window.openAddonModal = openAddonModal;
    window.closeAddonModal = closeAddonModal;
    window.editProduct = editProduct;
    window.editPlan = editPlan;
    window.editAddon = editAddon;
    window.deletePlan = deletePlan;
    window.deleteAddon = deleteAddon;
    window.openIconPicker = openIconPicker;
    window.closeIconPicker = closeIconPicker;
    window.filterIcons = filterIcons;
    window.selectIcon = selectIcon;
    window.confirmIconSelection = confirmIconSelection;
    window.saveCategory = saveCategory;
    window.closeCategoryModal = closeCategoryModal;
    window.saveProduct = saveProduct;
    window.savePlan = savePlan;
    window.saveAddon = saveAddon;
    window.addPlanFeature = addPlanFeature;
    window.formatCurrencyInput = formatCurrencyInput;
    
    console.log('Script carregado');
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded',function(){console.log('DOMContentLoaded disparado');updateIconPreview();initializeApp();});
    } else {
      console.log('DOM já carregado, executando initializeApp');
      updateIconPreview();
      initializeApp();
    }
  </script>
</body>
</html>
